
<html>
<head>
	<title>Leaflet Map</title>

	<link rel="stylesheet" href="css/leaflet.css" />
<meta name="viewport"  content="target-densitydpi=device-dpi, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<script src="js/leaflet.js"></script>
<script>L_DISABLE_3D = true;</script>
	<style>
		body {
			padding: 0;
			margin: 0;
		}
		html, body, #map {
			height: 100%;
		}
		img.leaflet-tile {
		    /* work-around from here: https://github.com/CloudMade/Leaflet/issues/161 */
		    outline: 1px solid transparent;
		}
	</style>
</head>
<body onload="initMap()">
	<div id="map"></div>

	<script>

		TourMe = {};

		// TODO
		RADIUS = 20000; //metres

		// Режим подготовки к поездке, маркеры отмечаются при нажатии 
		PREPARE_MODE = false; 

		function setRadius(r) {
			RADIUS = r*1000;
		}

		function setPrepareMode(flag) {
			PREPARE_MODE = flag == true ? true : false;
			
			TourMe.map.removeLayer(prepareModeLayer);
			TourMe.map.removeLayer(offlineLayer);
			TourMe.map.removeLayer(onlineLayer);
			TourMe.map.addLayer(prepareModeLayer);
			setZoom(5); // FIXME
		}

		function setUrl(url){
			Android.print(url);
			TourMe.url = url;
			TourMe.radious = 500;
		}

		// Double click Android WebView bug work around
		// No need in this hack in Leaflet v. 0.6.1 (currently in dev)
		var lastClickTime = 0;

		/**
		 * Устанавливает режим работы карты
		 * loadRegion - добавление регионов для загрузки
		 * simple - просто просмотр объектов
		 */
		function setMode(mode){
			TourMe.mode = mode;
		}

		function initMap(){
			
			url = "file:///mnt/sdcard/osmdroid/Mapnik/{z}/{x}/{y}.png"
			//Android.print(url);

			offlineLayer = L.tileLayer(url, {
				maxZoom: 18,
				attribution: 'Map data &copy; OpenStreetMap contributors'
			});

			onlineLayerAttribution = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';

			onlineLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: onlineLayerAttribution
			});

			prepareModeLayer = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				minZoom : 3,
				maxZoom : 8,
				attribution : onlineLayerAttribution
			});

			TourMe.map = L.map('map',{
				center: [61.800322,34.320819], // FIXME
				zoom: 15,
				layers: [onlineLayer],
				fadeAnimation: false,
				zoomAnimation: false,
				markerZoomAnimation: false
			});

			TourMe.mainMarkers = new L.layerGroup();			
			TourMe.mainMarkers.addTo(TourMe.map);

			TourMe.addMarkersLayer = new L.layerGroup();
			TourMe.addMarkersLayer.addTo(TourMe.map);

			TourMe.map.on('click', function(options){

				if (PREPARE_MODE) {
					var current = new Date().getTime();
	    			var delta = current - lastClickTime;

	    			android_webview_hack = L.Browser.android ? 400 : 0;

	    			// Android WebView bug hack
	    			// WebView emits ghost clicks near 300 ms
	    			if (delta > android_webview_hack) {
						var marker = L.marker(options.latlng);
						var circle = L.circle(options.latlng, RADIUS, {
							stroke: false,
						});
						
						//TourMe.addMarkersLayer.addLayer(marker);
						TourMe.addMarkersLayer.addLayer(circle);

						circle.on('click', function() {
							var click_current = new Date().getTime();
	    					var click_delta = click_current - lastClickTime;
	    					if (click_delta > android_webview_hack)
								TourMe.map.removeLayer(circle);
							window.lastClickTime = click_current;
						});
						//TourMe.map.invalidateSize(false);
					}

					window.lastClickTime = current;
				}
				
			});
		}

		function clearAllMarkers() {
			TourMe.addMarkersLayer.clearLayers();
		}
		
		function setOnlineLayer(){
			TourMe.map.removeLayer(prepareModeLayer);
			TourMe.map.removeLayer(offlineLayer);
			TourMe.map.removeLayer(onlineLayer);
			TourMe.map.addLayer(onlineLayer);
		}

		function setOfflineLayer(){
			TourMe.map.removeLayer(prepareModeLayer);
			TourMe.map.removeLayer(offlineLayer);
			TourMe.map.removeLayer(onlineLayer);
			TourMe.map.addLayer(offlineLayer);
		}

		function addMarker(group, lat, lng, description){
			var url = "js/images/markers/"+group+".png";
			var markerIcon = L.icon({
			    iconUrl: url,
			    iconSize:     [32, 37], // size of the icon
			    iconAnchor:   [16, 18], // point of the icon which will correspond to marker's location
			    popupAnchor:  [0, -10] // point from which the popup should open relative to the iconAnchor
			});

			var marker = L.marker([lat, lng], {icon: markerIcon}).bindPopup(description);

			TourMe.mainMarkers.addLayer(marker);
		}

		function print(){
			alrt("str");
		}

		function setZoom(num){
			TourMe.map.setZoom(num);
		}

		function centerWithZoomAt(latitude, longitude, zoom) {
			TourMe.map.setView([latitude, longitude], zoom, null);
		}

	</script>
</body>
</html>